@using Dashy.Net.Shared.Models
@using Dashy.Net.Shared.ViewModels
@using Dashy.Net.Web.Services
@using BlazorSortable

<div class="section-container" id="section-@Section.Id">
    <div class="section-header" @onclick="ToggleCollapse">
        <div class="section-header-left">
            <i class="fas fa-chevron-down section-chevron @(IsCollapsed ? "collapsed" : "")"></i>
            <h2>@Section.Name</h2>
            <p style="margin-left: 1rem; color: #ffc107;">(Items: @Section.Items.Count)</p>
        </div>
        @if (ViewOptions.IsEditMode)
        {
            <div class="section-edit-controls" @onclick:stopPropagation="true">
                <button class="edit-btn" title="Edit Section" @onclick="() => OnSectionEdited.InvokeAsync(Section)"><i class="fas fa-pencil-alt"></i></button>
                <button class="delete-btn" title="Delete Section" @onclick="() => OnSectionDeleted.InvokeAsync(Section)">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
        }
    </div>

    @* We apply the collapse class directly to the item-grid div *@
    <div class="item-grid @(IsCollapsed ? "collapsed" : "")">
        <SortableList Items="Section.Items" 
                      OnUpdate="(args) => OnItemOrderChanged.InvokeAsync((Section, (args.oldIndex, args.newIndex)))" 
                      Sort="ViewOptions.IsEditMode" 
                      Context="item">
            <div class="sortable-item" @key="item">
                @switch (item.Widget?.ToLower() ?? "static-link")
                {
                    case "static-link":
                        <StaticLinkWidget Item="item" OnItemDeleted="item => OnItemDeleted.InvokeAsync(item)" OnItemEdited="() => OnItemEdited.InvokeAsync(item)" />
                        break;
                    case "clock":
                        <ClockWidget Item="item" />
                        break;
                    default:
                        <UnknownWidget Widget="@item.Widget" />
                        break;
                }
            </div>
        </SortableList>

        @if (ViewOptions.IsEditMode)
        {
            <AddItemButton OnClick="() => OnItemAdded.InvokeAsync(Section.Id)" />
        }
    </div>
</div>

@code {
    [Parameter, EditorRequired]
    public SectionVm Section { get; set; } = default!;

    [Inject]
    private ViewOptionsService ViewOptions { get; set; } = default!;

    [Parameter]
    public bool IsCollapsed { get; set; }

    [Parameter]
    public EventCallback OnToggleCollapse { get; set; }

    [Parameter] public EventCallback<int> OnItemAdded { get; set; }
    [Parameter] public EventCallback<ItemVm> OnItemEdited { get; set; }
    [Parameter] public EventCallback<ItemVm> OnItemDeleted { get; set; }
    [Parameter] public EventCallback<SectionVm> OnSectionEdited { get; set; }
    [Parameter] public EventCallback<SectionVm> OnSectionDeleted { get; set; }
    [Parameter] public EventCallback<(SectionVm section, (int oldIndex, int newIndex) args)> OnItemOrderChanged { get; set; }

    private async Task ToggleCollapse()
    {
        await OnToggleCollapse.InvokeAsync();
    }
}