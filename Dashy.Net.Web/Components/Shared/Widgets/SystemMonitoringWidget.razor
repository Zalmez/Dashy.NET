@inherits WidgetBase
@inject IJSRuntime JSRuntime
@implements IDisposable

<WidgetChrome Title="@Item.Title"
              Icon="fas fa-desktop"
              SizeClass="@GetItemSizeClass()"
              ColorClass="@GetTileColorClass()"
              IsEditMode="@ViewOptions.IsEditMode"
              OnEdit="OnEditClick"
              OnDelete="OnDeleteClick"
              IsLoading="@_isLoading"
              HasError="@(!string.IsNullOrEmpty(_errorMessage))"
              ErrorMessage="@_errorMessage">
    <div class="sysmon-body">
        @if (ViewOptions.CurrentItemSize == ItemSize.Large)
        {
            <div class="tile-description">CPU: @_cpuUsage% | RAM: @_ramUsage MB | NET: @_networkUsage kB/s</div>
        }
        else if (ViewOptions.CurrentItemSize == ItemSize.Medium)
        {
            <div class="tile-description">CPU: @_cpuUsage% | RAM: @_ramUsage MB</div>
        }
        else
        {
            <div class="tile-description">CPU: @_cpuUsage%</div>
        }
    </div>
</WidgetChrome>

@code {
    private int _cpuUsage = 0;
    private int _ramUsage = 0;
    private int _networkUsage = 0;
    private Timer? _timer;
    private readonly Random _random = new();
    private bool _isLoading = true;
    private string? _errorMessage;

    private string GetTileColorClass()
    {
        return GetOption("tileColor") switch
        {
            "primary" => "purple",
            "secondary" => "pink",
            "success" => "green",
            "warning" => "orange",
            "danger" => "red",
            "info" => "teal",
            _ => string.Empty
        };
    }

    private async Task OnDeleteClick()
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete '{Item.Title}'?");
        if (IsDisposed) return;
        if (confirmed)
        {
            await OnItemDeleted.InvokeAsync(Item);
        }
    }

    private async Task OnEditClick() => await OnItemEdited.InvokeAsync();

    protected override void OnInitialized()
    {
        base.OnInitialized();
        _timer = new Timer(UpdateMetrics, null, TimeSpan.Zero, TimeSpan.FromSeconds(2));
        _isLoading = false;
    }

    private void UpdateMetrics(object? state)
    {
        _cpuUsage = _random.Next(10, 85);
        _ramUsage = _random.Next(2000, 8000);
        _networkUsage = _random.Next(50, 500);
        if (!IsDisposed)
        {
            InvokeAsync(StateHasChanged);
        }
    }

    public override void Dispose()
    {
        _timer?.Dispose();
        base.Dispose();
    }
}


